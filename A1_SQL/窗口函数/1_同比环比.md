好的，这是根据您的要求，将视频内容整理成的 Obsidian 笔记格式。

**原视频链接：** [SQL 窗口函数系列重磅回归！合辑篇](https://www.bilibili.com/video/BV1b34y147Re/)
**UP主：** 数据泥石流 (小倪老师)

### **核心问题汇总**

| 问题/知识点                          | 核心解答/要点                                                                                                             |
| :------------------------------ | :------------------------------------------------------------------------------------------------------------------ |
| 窗口函数的基本表达式是什么？                  | `$$FUNCTION() OVER (PARTITION BY ... ORDER BY ... frame_clause)$$`                                                  |
| `LAG()` 和 `LEAD()` 函数的作用和语法是什么？ | `LAG(expression, n)`: 取当前行之前的第 `n` 行的 `expression` 列的值。<br>`LEAD(expression, n)`: 取当前行之后的第 `n` 行的 `expression` 列的值。 |
| 如何用窗口函数实现**环比**增长率的计算？          | 使用 `LAG(value, 1)` 获取上一期的值，再用公式 `$$ (当期值 / 上一期值) - 1 $$` 计算。                                                        |
| 计算增长率时，需要注意什么数据类型问题？            | 整数相除结果仍为整数。为得到小数形式的增长率，需将分子或分母的数据类型转换为 `double` 或浮点型。                                                               |
| 如果数据中的日期不连续，如何计算环比？             | 构建一个**万年历表**，然后 `LEFT JOIN` 原始数据表，将日期补全。                                                                            |
| 如何用窗口函数实现**同比**增长率的计算？          | 如果数据是按月统计的，同比就是与 $12$ 个月前的数据比较，将 `LAG` 的第二个参数设为 $12$ 即可，即 `LAG(value, 12)`。                                         |

---

### **详细笔记**

数据点了生活, hi大家好, 我是数据泥石流, 大家可以叫小倪老师, 那本节课是窗口函数的第三集, 那这期我们来探讨一下如何使用前后函数去实现环比以及同比的求解。

#### **一、 复习：窗口函数表达式**

好在讲 `LAG` 跟 `LEAD` 函数之前, 我们先来复习一下窗口函数的表达式, 那想必大家对这个表达式都已经非常熟悉, 我们再过一遍。

`$$function() OVER (partition_clause order_clause frame_clause)$$`

这个 `OVER` 里面有三部分：
1.  **`PARTITION BY ...`**：根据什么做分组。
2.  **`ORDER BY ...`**：根据什么字段去做排序。不写等于默认就是升序, 如果是要降序, 这边要写 `DESC`。
3.  **Frame 子句 (`ROWS`/`RANGE`)**：上节课讲的重点, 这边frame模式可以采用两种, 分别是 `ROWS` 跟 `RANGE`, 然后基于这两种模式可以实现对行的滑动的操控。如果对frame这一块不太清楚的小伙伴可以去观看上一期视频。

#### **二、 核心函数：LAG 与 LEAD**

那本节课重点其实就是在于 `LAG` 跟 `LEAD` 函数, 那具体我们先来搞定 `function` 的这一块, 我这个 `function` 这里要怎么写好, 怎么写呢, 我们看到下面 `LEAD` 跟 `LAG` 函数。

括号里面第一个是 `expression`, 第二个是 `n`。
*   **`expression`**：意思就是说我要作用于哪一列。
*   **`n`**：我是往前或者往后去取几行。

什么意思呢, 大家可能会迷惑了, 这到底是什么意思, 我们通过一个简单的一个例子跟大家去讲讲啊, 就是还是上节课的这样一张表。

这张表有四列, 分别是产品、时间(这边时间是年月)、以及产品对应的部门、以及这个产品每一个月对应的GMV。

![](https://i.imgur.com/8QeRrcM.png)

我们如果站在这个第二行, 就是这个橙色的这一行数据, 我们想去寻找它**上一期**对应的GMV, 那我们这边这个函数应该怎么写？

1.  **选择函数**：首先是取上一期（当前行的上一期），那我们就是相当于是用 `LAG` 函数。
2.  **构建表达式**：
    *   `LAG()` 括号我们先写好。
    *   第一个参数 `expression` 是我作用的列，那这边是 `gmv`。
    *   第二个参数 `n` 是代表向上或者向下去取几行。`LAG` 是相当于向上取几行，我们取几行啊？我们取 $1$ 行, 因为我要得到上一期的一个对应的GMV的值, 所以我取 $1$ 行。

那其实这样一个表达式就是取到了上一期对应的GMV，相当于是 `$45$` 对吗？
好那我有了 `$45$`, 那我不就是 `$51$` ÷ `$45$` 再去减一, 就得到了一个环比的增幅, 这是不是很简单。

#### **三、 实战：求每个产品的GMV环比增幅**

其实这个函数这样讲下来就会发现这个函数很简单, 其实语法规则也非常的简单。那我们就再回到这个表, 我们的需求是去**求每个产品的GMV的环比增幅**。

那是不是相当于我要在当期我需要知道上一期对应的数字对吧, 然后用当期的值去除以上一期的数字, 再减去一, 这就是一个环比的涨幅。

好这个逻辑没有问题, 以后我们直接来看代码, 因为相对来说这个函数比较简单啊。

```sql
SELECT 
    *,
    -- 使用 LAG 函数获取上一期的 gmv
    LAG(gmv, 1) OVER (PARTITION BY department, product ORDER BY month) as last_month_gmv,
    -- 计算环比增长率
    (gmv * 1.0 / LAG(gmv, 1) OVER (PARTITION BY department, product ORDER BY month)) - 1 as gmv_growth_rate
FROM 
    your_table
```

来我们来看到第四行，`LAG` 和 `expression` 是 `gmv`, 就相当于对于 `gmv` 这一列做一个操作。
*   `LAG(gmv, 1)`: 我怎么操作呢, 取当前行的上一行, 那就是 `lag 1`。
*   `OVER (PARTITION BY department, product ORDER BY month)`:
    *   `PARTITION BY department, product`: 因为是要每一个产品去求, 所以呢这边我们 `PARTITION BY` 后面要写上 `product` 字段。当然咱们上节课说到这个 `department` 跟 `product` 是一对 `n` 的关系, 所以这边不写 `department` 也是OK的。
    *   `ORDER BY month`: `ORDER BY` 是一个时间的字段, 这个时间的字段是一个顺序的排列方式。

好, 相当于我们这个第四行的代码取到了上一期的GMV, 然后我们这边去求一个增长率。

**增长率计算与注意事项：**

其实很简单, 就是当期的值去除以上一期的值再减去一, 这就是一个增长率。
$$
增长率 = \frac{当期GMV}{上一期GMV} - 1
$$
那这边小伙伴要注意一下, 我们在求增长率的时候, 需要注意的地方是, 我们现在定义的 `gmv` 是一个**整形**, 那如果**整形除以整形得出来的结果也是个整形**。但是我们希望的一个增长率它是一个小数, 那怎么办呢？我们就将**分子或者是分母转换成 `double` 类型**。好, 这样的话我们得到的增长率就是一个小数。

**结果解读：**

我们解读一下这个结果。
*   **BS 产品**: 站在第二行, 那求去年 $11$ 月份相对于 $10$ 月份的环比增幅, 怎么求？就是 `$51$` 去除以 `$45$`, 然后减一, 那这求出来的结果是 `$0.13$`。
*   **Make up 产品**: 我们站在 `make up` 的今年 $3$ 月份的这一行数字, 我想求今年 $3$ 月份相对于今年 $2$ 月份的一个环比增幅, 怎么求？那就是 `$300$` 去除以 `$200$` 再去减一, 那这个结果是 `$0.5$`。

好啊, 那这个整体的逻辑实现是用 `LAG` 函数去做的。

#### **四、 补充与Q&A**

当然这边也可以用 `LEAD` 函数去做相应的求解, 那么其实 `LAG` 跟 `LEAD` 的区别啊, 这个再跟大家强调一下：
*   **`LAG`** 是取当前行的**前n行**。
*   **`LEAD`** 是当前行的**后n行**。

**Q&A: 数据日期不连续怎么办？**

之前小倪老师也讲到过, 利用前后函数来去求环比的视频, 有小伙伴问到说他的这个数据日期不连续, 那怎么办？
这个很好解决, 我们可以去**构建一个万年历的表**, 这个表呢去 **`LEFT JOIN`** 我们的订单表, 这样的话就可以得到一个连续日期的数据, 在此基础上就可以做环比的计算。

**思考：同比怎么算？**

那小伙伴会问了, 那这里是环比的计算, 同比怎么算？
那同比如果我们这个数据维度是以月为单位的, 那我同比是不是只要 `LAG(gmv, 12)` 这里改成 `$12$` 就可以了？大家可以思考一下。

以上就是本次视频的全部内容, 咱们下个视频见。